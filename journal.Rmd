---
title: "Journal (reproducible report)"
author: "Aibar Kobdabayev"
date: "2020-11-25"
output:
  html_document:
    toc: true
    toc_float: true
    collapsed: false
    number_sections: true
    toc_depth: 3
    #code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE,warning=FALSE, cache=TRUE)
```
# Challenge #1

Last compiled: `r Sys.Date()`

Analyze the sales by location (state) with a bar plot. Since state and city are multiple features (variables), they should be split. Which state has the highes revenue? 

## Load libraries:
```{r}
library(tidyverse)
library(readxl)

```

## Import files:
```{r}
bikes_tbl <- readxl::read_excel("./00_data/01_bike_sales/01_raw_data/bikes.xlsx")
orderlines_tbl <- readxl::read_excel("./00_data/01_bike_sales/01_raw_data/orderlines.xlsx")
bikeshops_tbl <- readxl::read_excel("./00_data/01_bike_sales/01_raw_data/bikeshops.xlsx")
```

## Examine data for imported tables:
```{r}
bikeshops_tbl
orderlines_tbl
bikes_tbl
```
## Data manipulation. Join tables:
```{r}
bike_orderlines_joined_tbl <- orderlines_tbl %>%
  dplyr::left_join(bikes_tbl, by = c("product.id" = "bike.id")) %>%
  dplyr::left_join(bikeshops_tbl, by = c("customer.id" = "bikeshop.id"))
bike_orderlines_joined_tbl %>% glimpse()
```

## Wrangling data:

```{r}
bike_orderlines_wrangled_tbl <- bike_orderlines_joined_tbl %>%
    tidyr::separate(col    = location,
           into   = c("city", "state"),
           sep    = ", ") %>%
  dplyr::mutate(total_price = price * quantity) %>%
  dplyr::select(order.id, contains("order"), city, state, quantity, total_price, everything()) %>%
  rename(bikeshop = name) %>%
  magrittr::set_names(names(.) %>% stringr::str_replace_all("\\.", "_"))

bike_orderlines_wrangled_tbl
```
## Business insights
Creating relevant tables and using gglpot2 package for data visualization.

```{r}
sales_by_states_tbl <- bike_orderlines_wrangled_tbl %>%
  select(order_date, total_price, state) %>%
  mutate(year = year(order_date)) %>%
  group_by(year, state) %>%
  summarise(sales = sum(total_price)) %>%
  ungroup() %>%
  mutate(sales_text = scales::dollar(sales, big.mark = ".",
                                            decimal.mark = ",",
                                            prefix = "",
                                            suffix = " €"))
sales_by_states_tbl
```
```{r}
sales_by_states_tbl %>%
  ggplot2::ggplot(aes(x = year, y = sales, fill = state)) +
  ggplot2::geom_col() +
  ggplot2::facet_wrap(~ state) +
  ggplot2::scale_y_continuous(labels = scales::dollar_format(big.mark = ".",
                                                             decimal.mark = ",",
                                                             prefix = "",
                                                             suffix = " €")) +
  ggplot2::theme(axis.text = element_text(angle = 45, hjust = 1))

  ggplot2::labs(title = "Sales by states")
  
```



# Challenge #2
   a) Get some data via an API. There are millions of providers, that offer API access for free and have good documentation about how to query their service. You just have to google them. You can use whatever service you want. For example, you can get data about your listening history (spotify), get data about flights (skyscanner) or just check the weather forecast.

   b) Scrape one of the competitor websites of canyon (either https://www.rosebikes.de/ or https://www.radon-bikes.de) and create a small database. The database should contain the model names and prices for at least one category. Use the selectorgadget to get a good understanding of the website structure.
   
```{r}
#Data acquisition challenge a)
rick_and_morty_character <- function(path) {
  url <- modify_url(url = "https://rickandmortyapi.com", path = glue("/api/character/{path}"))
  resp <- GET(url)
  stop_for_status(resp)
}
resp <- rick_and_morty_character("/3") #enter the number of character
content(resp, as = "parsed")
```




